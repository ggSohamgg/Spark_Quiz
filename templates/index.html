<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Quiz Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>üß† AI Quiz Generator</h1>
        <div id="usage-info" class="info-box"></div>
        <form id="quiz-form">
            <label>Topic:</label>
            <input type="text" name="topic" required placeholder="e.g. Quantum Physics">

            <label>Difficulty:</label>
            <select name="difficulty">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
            </select>

            <label>Number of Questions:</label>
            <input type="number" name="num_questions" min="1" max="10" value="5">

            <label>Question Types:</label>
            <select name="question_types" multiple size="3">
                <option value="multiple choice" selected>Multiple Choice</option>
                <option value="short answer">Short Answer</option>
                <option value="true/false">True/False</option>
            </select>

            <label>Specific Sub-topics (optional, comma separated):</label>
            <input type="text" name="subtopics" placeholder="e.g. Wave-particle duality, Quantum entanglement">

            <label>Context Keywords (optional, comma separated):</label>
            <input type="text" name="keywords" placeholder="e.g. experiment, theory, equation">

            <label>Target Audience (optional):</label>
            <input type="text" name="audience" placeholder="e.g. Undergraduate Physics Students">

            <label>Language (optional):</label>
            <input type="text" name="language" placeholder="e.g. en (default English)">

            <label>Include Explanations?</label>
            <select name="include_explanations">
                <option value="yes" selected>Yes</option>
                <option value="no">No</option>
            </select>

            <label>Maximum Length per Question (optional, in words):</label>
            <input type="number" name="max_length" min="0" placeholder="e.g. 30">

            <button type="submit">Generate Quiz</button>
        </form>
        <div id="quiz-output"></div>
    </div>
    <footer>
        <div class="about-box">
            <h3>About this App</h3>
            <p>
                This AI Quiz Generator uses the <b>Qwen-2.5-72B-Instruct</b> model via OpenRouter.ai.<br>
                It can generate quizzes on any topic, with customizable difficulty, question types, sub-topics, and more.<br>
                <i>Powered by open-source LLMs & OpenRouter API. For educational use only!</i>
            </p>
        </div>
        <p>Made with ‚ù§Ô∏è for learning. &copy; 2025</p>
    </footer>
    <script>
    // Show usage info
    async function fetchUsage() {
        const resp = await fetch('/usage');
        const data = await resp.json();
        if (data.error) {
            document.getElementById('usage-info').innerText = "Usage info unavailable";
        } else if (data.limit !== null && data.remaining !== null) {
            document.getElementById('usage-info').innerText =
                `OpenRouter API requests left today: ${data.remaining} of ${data.limit}`;
        } else if (data.per_min && data.interval) {
            document.getElementById('usage-info').innerText =
                `OpenRouter Free Tier: Up to ${data.per_min} requests per ${data.interval}.`;
        } else {
            document.getElementById('usage-info').innerText = "Usage info unavailable";
        }
    }
    fetchUsage();

    // Handle quiz form submission
    document.getElementById('quiz-form').onsubmit = async function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        // Parse multiple selects and comma-separated fields
        const question_types = formData.getAll('question_types');
        const subtopics = formData.get('subtopics') ? formData.get('subtopics').split(',').map(s => s.trim()).filter(Boolean) : [];
        const keywords = formData.get('keywords') ? formData.get('keywords').split(',').map(s => s.trim()).filter(Boolean) : [];
        const parameters = {
            topic: formData.get('topic'),
            difficulty: formData.get('difficulty'),
            num_questions: formData.get('num_questions'),
            question_types: question_types,
            subtopics: subtopics,
            keywords: keywords,
            audience: formData.get('audience'),
            language: formData.get('language') || "en",
            include_explanations: formData.get('include_explanations') === "yes",
            max_length: formData.get('max_length')
        };
        document.getElementById('quiz-output').innerHTML = "<div class='loading'>Generating quiz...</div>";
        const response = await fetch('/generate_quiz', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(parameters)
        });
        const result = await response.json();
        let html = "<h2>Your Quiz</h2>";
        if (result.quiz && result.quiz.length > 0) {
            result.quiz.forEach((q, i) => {
                html += `<div class='question-card'><b>${i+1}. ${q.question}</b><br>`;
                if (q.options && q.options.length > 0) {
                    html += "<ul>";
                    q.options.forEach(opt => {
                        html += `<li>${opt}</li>`;
                    });
                    html += "</ul>";
                }
                if (q.answer) {
                    html += `<div class='answer'><b>Answer:</b> ${q.answer}</div>`;
                }
                if (q.explanation) {
                    html += `<div class='explanation'><i>${q.explanation}</i></div>`;
                }
                html += "</div>";
            });
        } else {
            html += "<div class='error'>Sorry, no quiz could be generated.</div>";
        }
        document.getElementById('quiz-output').innerHTML = html;
        fetchUsage(); // update usage info after quiz generation
    }
    </script>
</body>
</html>
