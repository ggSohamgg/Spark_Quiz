<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NebulaQuiz AI Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="starfield"></div>
    <div class="container">
        <h1>üåå NebulaQuiz AI Generator</h1>
        <div id="usage-info" class="info-box"></div>
        <form id="quiz-form" autocomplete="off">
            <div class="main-fields">
                <div class="input-group">
                    <label for="topic">Topic</label>
                    <input type="text" id="topic" name="topic" required placeholder="e.g., Quantum Physics">
                </div>

                <div class="input-group">
                    <label>Difficulty</label>
                    <div class="difficulty-group">
                        <button type="button" class="diff-btn selected" data-value="easy">Easy</button>
                        <button type="button" class="diff-btn" data-value="medium">Medium</button>
                        <button type="button" class="diff-btn" data-value="hard">Hard</button>
                    </div>
                    <input type="hidden" name="difficulty" id="difficulty_input" value="easy">
                </div>

                <div class="input-group">
                    <label for="num_questions">Number of Questions</label>
                    <input type="number" id="num_questions" name="num_questions" min="1" max="10" value="3">
                </div>

                <div class="input-group">
                    <label>Desired Question Types</label>
                    <div class="question-type-group" id="question-type-group">
                        <button type="button" class="qt-btn selected" data-value="multiple choice">
                            <span>üìù</span> Multiple Choice
                        </button>
                        <button type="button" class="qt-btn" data-value="short answer">
                            <span>‚úèÔ∏è</span> Short Answer
                        </button>
                        <button type="button" class="qt-btn" data-value="true/false">
                            <span>‚úÖ</span> True/False
                        </button>
                    </div>
                    <input type="hidden" name="question_types" id="question_types_input" value="multiple choice">
                </div>
            </div>

            <details class="advanced-options">
                <summary>Advanced Settings ‚öôÔ∏è</summary>
                <div class="advanced-content">
                    <div class="input-group">
                        <label for="subtopics">Sub-topics (comma-separated)</label>
                        <input type="text" id="subtopics" name="subtopics" placeholder="e.g., Wave-particle duality, Quantum entanglement">
                    </div>
                    <div class="input-group">
                        <label for="keywords">Context Keywords (comma-separated)</label>
                        <input type="text" id="keywords" name="keywords" placeholder="e.g., experiment, theory, equation">
                    </div>
                    <div class="input-group">
                        <label for="audience">Target Audience</label>
                        <input type="text" id="audience" name="audience" placeholder="e.g., High School Students">
                    </div>
                    <div class="input-group">
                        <label for="language">Language</label>
                        <input type="text" id="language" name="language" placeholder="e.g., en (default English)">
                    </div>
                    <div class="input-group">
                        <label for="include_explanations">Include Explanations?</label>
                        <select id="include_explanations" name="include_explanations">
                            <option value="yes" selected>Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="max_length">Max Length per Question (words)</label>
                        <input type="number" id="max_length" name="max_length" min="0" placeholder="e.g., 30">
                    </div>
                </div>
            </details>

            <button type="submit" class="main-btn">Launch Quiz üöÄ</button>
        </form>
        <div id="quiz-output"></div>
    </div>
    <footer>
        <div class="about-box">
            <h3>About NebulaQuiz AI</h3>
            <p>
                Powered by <b>Qwen-2.5-72B-Instruct</b> via OpenRouter.ai, NebulaQuiz creates cosmic learning experiences. 
                Customize your journey through the stars with tailored quizzes.<br>
                <i>For educational use. Explore the universe of knowledge!</i>
            </p>
        </div>
        <p>Made with üå† for learning. ¬© 2025</p>
    </footer>
    <script>
        // Difficulty button group
        const diffGroup = document.querySelector('.difficulty-group');
        const diffInput = document.getElementById('difficulty_input');
        diffGroup.addEventListener('click', function(e) {
            if (e.target.closest('.diff-btn')) {
                diffGroup.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('selected'));
                const btn = e.target.closest('.diff-btn');
                btn.classList.add('selected');
                diffInput.value = btn.dataset.value;
            }
        });

        // Question type button group
        const qtGroup = document.getElementById('question-type-group');
        const qtInput = document.getElementById('question_types_input');
        qtGroup.addEventListener('click', function(e) {
            if (e.target.closest('.qt-btn')) {
                const btn = e.target.closest('.qt-btn');
                btn.classList.toggle('selected');
                const selected = Array.from(qtGroup.querySelectorAll('.qt-btn.selected')).map(b => b.dataset.value);
                qtInput.value = selected.join(',');
            }
        });

        // Usage info
        async function fetchUsage() {
            const resp = await fetch('/usage');
            const data = await resp.json();
            const infoBox = document.getElementById('usage-info');
            if (data.error) {
                infoBox.innerText = "Usage info unavailable";
            } else if (data.limit !== null && data.remaining !== null) {
                infoBox.innerText = `OpenRouter API requests left today: ${data.remaining} of ${data.limit}`;
            } else if (data.per_min && data.interval) {
                infoBox.innerText = `OpenRouter Free Tier: Up to ${data.per_min} requests per ${data.interval}.`;
            } else {
                infoBox.innerText = "Usage info unavailable";
            }
        }
        fetchUsage();

        // Form submission
        document.getElementById('quiz-form').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const question_types = formData.get('question_types').split(',').filter(Boolean);
            const subtopics = formData.get('subtopics') ? formData.get('subtopics').split(',').map(s => s.trim()).filter(Boolean) : [];
            const keywords = formData.get('keywords') ? formData.get('keywords').split(',').map(s => s.trim()).filter(Boolean) : [];
            const parameters = {
                topic: formData.get('topic'),
                difficulty: formData.get('difficulty'),
                num_questions: formData.get('num_questions'),
                question_types: question_types,
                subtopics: subtopics,
                keywords: keywords,
                audience: formData.get('audience'),
                language: formData.get('language') || "en",
                include_explanations: formData.get('include_explanations') === "yes",
                max_length: formData.get('max_length')
            };
            document.getElementById('quiz-output').innerHTML = "<div class='loading'>Navigating the cosmos...</div>";
            const response = await fetch('/generate_quiz', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(parameters)
            });
            const result = await response.json();
            let html = "<h2>Your Cosmic Quiz</h2>";
            if (result.quiz && result.quiz.length > 0) {
                result.quiz.forEach((q, i) => {
                    html += `<div class='question-card'><b>${i+1}. ${q.question}</b><br>`;
                    if (q.options && q.options.length > 0) {
                        html += "<ul>";
                        q.options.forEach(opt => {
                            html += `<li>${opt}</li>`;
                        });
                        html += "</ul>";
                    }
                    if (q.answer) {
                        html += `<div class='answer'><b>Answer:</b> ${q.answer}</div>`;
                    }
                    if (q.explanation) {
                        html += `<div class='explanation'><i>${q.explanation}</i></div>`;
                    }
                    html += "</div>";
                });
            } else {
                html += "<div class='error'>The stars couldn't align a quiz this time.</div>";
            }
            document.getElementById('quiz-output').innerHTML = html;
            fetchUsage();
        };

        // Starfield animation
        const starfield = document.querySelector('.starfield');
        for (let i = 0; i < 200; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = `${Math.random() * 100}vw`;
            star.style.top = `${Math.random() * 100}vh`;
            star.style.animationDuration = `${Math.random() * 3 + 2}s`;
            starfield.appendChild(star);
        }
    </script>
</body>
</html>
