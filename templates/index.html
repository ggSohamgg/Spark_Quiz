<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SparkQuiz - AI Quiz Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>SparkQuiz - AI Quiz Generator</h1>
        <div id="usage-info" class="info-box"></div>
        <form id="quiz-form" autocomplete="off">
            <div class="main-fields">
                <div class="row">
                    <div class="input-group">
                        <label for="topic">Topic</label>
                        <input type="text" id="topic" name="topic" required placeholder="e.g., Quantum Physics">
                    </div>
                    <div class="input-group">
                        <label for="num_questions">Number of Questions</label>
                        <input type="number" id="num_questions" name="num_questions" min="1" max="10" value="3">
                    </div>
                </div>
                <div class="row">
                    <div class="input-group">
                        <label for="difficulty">Difficulty</label>
                        <select id="difficulty" name="difficulty">
                            <option value="easy" selected>Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Desired Question Types</label>
                        <div class="question-type-group" id="question-type-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="question_types" value="multiple choice" checked>
                                Multiple Choice
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="question_types" value="single choice">
                                Single Choice
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="question_types" value="yes or no">
                                Yes or No
                            </label>
                        </div>
                        <input type="hidden" name="question_types_hidden" id="question_types_input">
                    </div>
                </div>
            </div>

            <details class="advanced-options">
                <summary>Advanced Settings</summary>
                <div class="advanced-content">
                    <div class="row">
                        <div class="input-group">
                            <label for="subtopics">Sub-topics (comma-separated)</label>
                            <input type="text" id="subtopics" name="subtopics" placeholder="e.g., Wave-particle duality, Quantum entanglement">
                        </div>
                        <div class="input-group">
                            <label for="keywords">Context Keywords (comma-separated)</label>
                            <input type="text" id="keywords" name="keywords" placeholder="e.g., experiment, theory, equation">
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-group">
                            <label for="audience">Target Audience</label>
                            <input type="text" id="audience" name="audience" placeholder="e.g., High School Students">
                        </div>
                        <div class="input-group">
                            <label for="language">Language</label>
                            <input type="text" id="language" name="language" placeholder="e.g., en (default English)">
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-group">
                            <label for="include_explanations">Include Explanations?</label>
                            <select id="include_explanations" name="include_explanations">
                                <option value="yes" selected>Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="max_length">Max Length per Question (words)</label>
                            <input type="number" id="max_length" name="max_length" min="0" placeholder="e.g., 30">
                        </div>
                    </div>
                </div>
            </details>

            <button type="submit" class="main-btn">Generate Quiz</button>
        </form>
        <div id="quiz-output"></div>
    </div>
    <footer>
        <div class="about-box">
            <h3>About SparkQuiz</h3>
            <p>
                Powered by <b>Qwen-2.5-72B-Instruct</b> via OpenRouter.ai, SparkQuiz creates tailored quizzes for learning. 
                Customize your quiz with ease and explore any topic.<br>
                <i>For educational use. Spark your curiosity!</i>
            </p>
        </div>
        <p>Made with care for learning. Â© 2025</p>
    </footer>
    <script>
        // Question type checkbox handling
        const qtGroup = document.getElementById('question-type-group');
        const qtInput = document.getElementById('question_types_input');
        qtGroup.addEventListener('change', function() {
            const selected = Array.from(qtGroup.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
            qtInput.value = selected.join(',');
        });

        // Usage info
        async function fetchUsage() {
            const resp = await fetch('/usage');
            const data = await resp.json();
            const infoBox = document.getElementById('usage-info');
            if (data.error) {
                infoBox.innerText = "Usage info unavailable";
            } else if (data.limit !== null && data.remaining !== null) {
                infoBox.innerText = `OpenRouter API requests left today: ${data.remaining} of ${data.limit}`;
            } else if (data.per_min && data.interval) {
                infoBox.innerText = `OpenRouter Free Tier: Up to ${data.per_min} requests per ${data.interval}.`;
            } else {
                infoBox.innerText = "Usage info unavailable";
            }
        }
        fetchUsage();

        // Form submission
        document.getElementById('quiz-form').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const question_types = formData.get('question_types_hidden') ? formData.get('question_types_hidden').split(',').filter(Boolean) : [];
            const subtopics = formData.get('subtopics') ? formData.get('subtopics').split(',').map(s => s.trim()).filter(Boolean) : [];
            const keywords = formData.get('keywords') ? formData.get('keywords').split(',').map(s => s.trim()).filter(Boolean) : [];
            const parameters = {
                topic: formData.get('topic'),
                difficulty: formData.get('difficulty'),
                num_questions: formData.get('num_questions'),
                question_types: question_types,
                subtopics: subtopics,
                keywords: keywords,
                audience: formData.get('audience'),
                language: formData.get('language') || "en",
                include_explanations: formData.get('include_explanations') === "yes",
                max_length: formData.get('max_length')
            };
            document.getElementById('quiz-output').innerHTML = "<div class='loading'>Generating your quiz...</div>";
            const response = await fetch('/generate_quiz', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(parameters)
            });
            const result = await response.json();
            let html = "<h2>Your SparkQuiz</h2>";
            if (result.quiz && result.quiz.length > 0) {
                result.quiz.forEach((q, i) => {
                    html += `<div class='question-card'><b>${i+1}. ${q.question}</b><br>`;
                    if (q.options && q.options.length > 0) {
                        html += "<ul>";
                        q.options.forEach(opt => {
                            html += `<li>${opt}</li>`;
                        });
                        html += "</ul>";
                    }
                    if (q.answer) {
                        html += `<div class='answer'><b>Answer:</b> ${q.answer}</div>`;
                    }
                    if (q.explanation) {
                        html += `<div class='explanation'><i>${q.explanation}</i></div>`;
                    }
                    html += "</div>";
                });
            } else {
                html += "<div class='error'>Unable to generate a quiz at this time.</div>";
            }
            document.getElementById('quiz-output').innerHTML = html;
            fetchUsage();
        };
    </script>
</body>
</html>
